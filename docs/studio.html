<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#0b0f17">
<title>Studio</title>
<link rel="manifest" href="manifest.webmanifest">
<style>
:root{--bg:#0b0f17;--panel:#0f1522;--line:#1f2937;--text:#e5e7eb;--accent:#7c3aed}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{background:#0b0f17;color:var(--text);font:14px/1.6 system-ui,Roboto,Arial;overflow:hidden;display:flex;flex-direction:column}
header{display:flex;gap:8px;align-items:center;padding:10px 12px;background:#0f1522;border-bottom:1px solid var(--line)}
header input{flex:1;min-width:0;padding:6px 10px;border:1px solid var(--line);border-radius:8px;background:#0b1324;color:var(--text)}
button{border:1px solid var(--line);border-radius:8px;padding:0 12px;height:34px;background:#141c2e;color:var(--text);cursor:pointer}
button.primary{background:linear-gradient(180deg,#7c3aed,#5b21b6);border-color:#7c3aed}
main{flex:1;display:grid;grid-template-columns:260px 1fr 1fr;min-height:0}
aside{border-right:1px solid var(--line);background:#0c1323;overflow:auto}
#list{list-style:none;margin:0;padding:8px}
#list li{padding:8px;border-radius:8px;display:flex;justify-content:space-between;gap:8px;cursor:pointer}
#list li.active{background:#121a35}
#editor{border-right:1px solid var(--line);background:#0b1324}
#code{width:100%;height:100%;border:0;outline:0;padding:14px 16px;background:transparent;color:var(--text);font-family:ui-monospace,Consolas,monospace}
#frame{width:100%;height:100%;border:0;background:#0b1324}
@media(max-width:900px){
main{grid-template-columns:1fr}
aside,#editor,.preview{display:none}
body.view-files aside{display:block}
body.view-editor #editor{display:block}
body.view-preview .preview{display:block}
.tabs{display:flex;gap:8px;padding:8px 12px;background:#0f1522;border-bottom:1px solid var(--line)}
.tabs button{flex:1;border:1px solid var(--line);background:#121a2e;color:var(--text);padding:10px;border-radius:8px}
.tabs button.active{background:#18233c}
}
</style>
</head>
<body class="view-files">
<header>
  <b>Studio</b>
  <input id="prompt" placeholder="Décris ce que tu veux générer">
  <button id="ai-propose" class="primary">IA Proposer</button>
  <button id="save">Enregistrer</button>
  <button id="preview">Aperçu</button>
</header>

<div class="tabs" style="display:none">
  <button data-v="files" class="active">Fichiers</button>
  <button data-v="editor">Éditeur</button>
  <button data-v="preview">Aperçu</button>
</div>

<main>
  <aside><ul id="list"></ul></aside>
  <section id="editor"><textarea id="code"></textarea></section>
  <section class="preview"><iframe id="frame" sandbox="allow-scripts"></iframe></section>
</main>

<script type="module" src="studio.js"></script>
</body>
</html>    #frame{width:100%;height:100%;border:0;background:#0b1324}
    .is-mobile main{display:block;height:calc(100vh - 116px)}
    .is-mobile #mobile-tabs{display:flex}
    .is-mobile #files,.is-mobile #editor,.is-mobile .preview{display:none}
    .is-mobile.view-files #files{display:block}
    .is-mobile.view-editor #editor{display:block}
    .is-mobile.view-preview .preview{display:block}
  </style>
</head>
<body>
  <header>
    <div class="logo"><span class="dot"></span><b>Studio</b></div>
    <input id="prompt" placeholder="Décris ce que tu veux générer">
    <button id="ai-propose" class="primary">IA Proposer</button>
    <button id="ai-analyze">IA Analyser</button>
    <button id="new">Nouveau</button>
    <button id="rename">Renommer</button>
    <button id="delete">Supprimer</button>
    <button id="save">Enregistrer</button>
    <button id="download">ZIP</button>
    <button id="import">Importer</button><input id="zip" type="file" accept=".zip" style="display:none">
    <button id="preview">Aperçu</button>
    <button id="reset">Reset</button>
    <output id="status"></output>
  </header>

  <nav id="mobile-tabs">
    <button data-v="files" class="active">Fichiers</button>
    <button data-v="editor">Éditeur</button>
    <button data-v="preview">Aperçu</button>
  </nav>

  <main>
    <aside id="files"><div class="bar"><span>Fichiers</span><span>Local</span></div><ul id="list"></ul></aside>
    <section id="editor"><textarea id="code"></textarea></section>
    <section class="preview"><iframe id="frame" sandbox="allow-scripts"></iframe></section>
  </main>

  <script src="ai.js"></script>
  <script type="module" src="studio.js"></script>
</body>
</html>
    /* Mobile tabs */
    #mobile-tabs{display:none;gap:8px;padding:8px 12px;background:#0f1522;border-bottom:1px solid var(--line)}
    #mobile-tabs button{flex:1;border:1px solid var(--line);background:#121a2e;color:var(--text);
      padding:10px;border-radius:10px}
    #mobile-tabs button.active{background:#18233c;border-color:#2b3a55}

    /* Main grid */
    main{height:calc(100% - 58px);display:grid;grid-template-columns:280px 1fr 1fr}
    aside#files{border-right:1px solid var(--line);background:linear-gradient(180deg,#0c1323,#0a1020);overflow:auto}
    #files .bar{display:flex;justify-content:space-between;align-items:center;
      padding:10px 12px;border-bottom:1px solid var(--line);color:var(--muted);font-size:12px}
    #files ul{list-style:none;margin:0;padding:8px}
    #files li{padding:8px 10px;border-radius:10px;cursor:pointer;display:flex;justify-content:space-between;gap:8px;color:#d1d5db;border:1px solid transparent}
    #files li:hover{background:#0e1530;border-color:#1b2442}
    #files li.active{background:linear-gradient(180deg,#121a35,#0e1530);border-color:#26314e}
    #files .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    section#editor{border-right:1px solid var(--line);background:linear-gradient(180deg,#0b1324,#0a1020)}
    textarea#code{width:100%;height:100%;border:0;outline:0;padding:14px 16px;resize:none;
      background:transparent;color:#e5e7eb;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:13.5px;line-height:1.55}

    section.preview{border-left:1px solid var(--line);background:#0b1324}
    iframe#frame{width:100%;height:100%;border:0;background:#0b1324}

    /* Responsive */
    .is-mobile main{display:block;height:calc(100vh - 116px)}
    .is-mobile #mobile-tabs{display:flex}
    .is-mobile #files,.is-mobile #editor,.is-mobile .preview{display:none}
    .is-mobile.view-files #files{display:block}
    .is-mobile.view-editor #editor{display:block}
    .is-mobile.view-preview .preview{display:block}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <header>
    <div class="logo"><span class="dot"></span><b>Studio</b></div>
    <input id="prompt" placeholder="Décris ce que tu veux générer">
    <button id="ai-propose" class="primary">IA Proposer</button>
    <button id="ai-analyze">IA Analyser</button>
    <output id="status"></output>
  </header>

  <nav id="mobile-tabs">
    <button data-v="files" class="active">Fichiers</button>
    <button data-v="editor">Éditeur</button>
    <button data-v="preview">Aperçu</button>
  </nav>

  <main>
    <aside id="files">
      <div class="bar"><span>Fichiers</span><span>Local</span></div>
      <ul id="list"></ul>
    </aside>

    <section id="editor">
      <textarea id="code"></textarea>
    </section>

    <section class="preview">
      <iframe id="frame" sandbox="allow-scripts"></iframe>
    </section>
  </main>

  <script src="ai.js"></script>
  <script type="module">
    const KEY="studio.fs.v1";
    const list=document.getElementById("list");
    const code=document.getElementById("code");
    const frame=document.getElementById("frame");
    const promptInput=document.getElementById("prompt");
    const statusOut=document.getElementById("status");
    const tabs=document.querySelectorAll('#mobile-tabs button');

    let fs=loadFS();
    let current=null;
    let history={};let cursor={};
    let typingTimer=null;
    let lock=false;

    /* UI helpers */
    function setStatus(t){statusOut.textContent=t}
    function setLock(v){
      lock=v;
      for(const el of [document.getElementById("ai-propose"),document.getElementById("ai-analyze"),promptInput]){
        if(el){el.disabled=v; el.style.opacity=v?0.7:1}
      }
    }

    /* Mobile layout */
    function applyMobileMode(){
      const m = matchMedia("(max-width:900px)").matches;
      if(m){
        document.body.classList.add("is-mobile","view-files");
        tabs.forEach(b=>b.onclick=()=>{
          tabs.forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          document.body.classList.remove("view-files","view-editor","view-preview");
          document.body.classList.add("view-"+b.dataset.v);
        });
      }else{
        document.body.classList.remove("is-mobile","view-files","view-editor","view-preview");
      }
    }
    addEventListener("resize",applyMobileMode);

    /* FS */
    function loadFS(){
      try{
        const raw=localStorage.getItem(KEY);
        return raw?JSON.parse(raw):{
          "index.html":"<!doctype html><html><head><meta charset='utf-8'><title>Exemple</title><style>body{font:16px/1.5 system-ui;margin:24px}</style></head><body><h1>Bonjour</h1><p>Modifie ce fichier puis clique Aperçu.</p></body></html>"
        };
      }catch{return {"index.html":"<!doctype html><meta charset='utf-8'><title>Exemple</title><h1>Bonjour</h1>"}}
    }
    function saveFS(){localStorage.setItem(KEY,JSON.stringify(fs))}
    function renderList(){
      list.innerHTML="";
      Object.keys(fs).sort().forEach(name=>{
        const li=document.createElement("li");
        li.dataset.name=name;
        li.className=name===current?"active":"";
        const n=document.createElement("span");n.className="name";n.textContent=name;
        const s=document.createElement("span");s.textContent=(new Blob([fs[name]]).size)+"o";
        li.append(n,s);
        li.onclick=()=>openFile(name);
        list.appendChild(li);
      });
    }
    function openFile(name){
      if(!fs[name])return;
      commitState();
      current=name;
      code.value=fs[name];
      renderList();
      resetHistoryIfNeeded(name);
      preview();
    }
    function resetHistoryIfNeeded(name){
      if(!history[name]){history[name]=[fs[name]];cursor[name]=0}
      else{cursor[name]=history[name].length-1}
    }
    function commitState(){
      if(!current)return;
      const arr=history[current]||[fs[current]];
      const idx=cursor[current]??(arr.length-1);
      const latest=arr[idx];
      if(code.value!==latest){
        const next=arr.slice(0,idx+1); next.push(code.value);
        history[current]=next; cursor[current]=next.length-1;
        fs[current]=code.value; saveFS();
      }
    }

    /* Preview via srcdoc only */
    function preview(){
      commitState();
      const html = fs[current] || "<!doctype html><meta charset='utf-8'><title>Vide</title><p>Fichier vide</p>";
      frame.srcdoc = html;
    }

    /* Editor typing debounce */
    code.addEventListener("input",()=>{
      clearTimeout(typingTimer);
      typingTimer = setTimeout(preview, 300);
    });

    /* IA actions */
    document.getElementById("ai-propose").onclick=async()=>{
      if(lock)return; setLock(true); setStatus("IA en cours");
      try{
        const res = await window.ai.generate(promptInput.value||"");
        if(res && res.files){
          // fusion dans FS
          const updates=res.files;
          for(const [p,c] of Object.entries(updates)) fs[p]=c;
          saveFS(); renderList();
          const names=Object.keys(updates);
          const target = names.includes("index.html") ? "index.html" : names[0];
          if(target) openFile(target); else preview();
        }
        setStatus(res?.summary || "IA terminé");
        setTimeout(()=>setStatus(""),1500);
      }catch{ setStatus("Erreur IA") }
      finally{ setLock(false) }
    };

    document.getElementById("ai-analyze").onclick=async()=>{
      if(lock)return; setLock(true); setStatus("Analyse en cours");
      try{
        const res = await window.ai.analyze();
        const html = [
          "<!doctype html><meta charset='utf-8'><title>Analyse</title>",
          "<style>body{font:14px system-ui;margin:20px;line-height:1.6;color:#e5e7eb;background:#0b1324}",
          "h1{margin:0 0 8px}h2{margin:16px 0 8px}ul{padding-left:18px}</style>",
          "<h1>Analyse</h1>",
          section("Problèmes",res?.issues),
          section("Actions",res?.actions),
          section("Avertissements",res?.warnings)
        ].join("");
        frame.srcdoc = html;
        setStatus("Analyse affichée");
        setTimeout(()=>setStatus(""),1500);
      }catch{ setStatus("Erreur analyse") }
      finally{ setLock(false) }
    };
    function section(title,items){
      const arr = Array.isArray(items)?items:[];
      return "<h2>"+title+"</h2><ul>"+arr.map(x=>"<li>"+String(x)+"</li>").join("")+"</ul>";
    }

    /* Init */
    applyMobileMode();
    renderList();
    if(!current){ openFile(Object.keys(fs)[0]); } else { preview(); }

    /* PWA SW */
    if ("serviceWorker" in navigator){
      addEventListener("load",()=>navigator.serviceWorker.register("sw.js"));
    }
  </script>
</body>
</html>let current=null;
let history={};let cursor={};
let typingTimer=null;
let lock=false;

function setStatus(t){statusOut.textContent=t}
function setLock(v){lock=v;for(const id of ["ai-propose","ai-analyze","new","rename","delete","save","download","import","preview","reset"]){const el=document.getElementById(id);if(!el)continue;el.disabled=v;el.style.opacity=v?.6:1}promptInput.disabled=v}

function applyMobileMode(){const m=window.matchMedia("(max-width: 900px)").matches;if(m){document.body.classList.add("is-mobile","view-files");tabs.forEach(b=>b.onclick=()=>{tabs.forEach(x=>x.classList.remove("active"));b.classList.add("active");document.body.classList.remove("view-files","view-editor","view-preview");document.body.classList.add("view-"+b.dataset.v)})}else{document.body.classList.remove("is-mobile","view-files","view-editor","view-preview")}}
window.addEventListener("resize",applyMobileMode);

function loadFS(){try{const raw=localStorage.getItem(KEY);return raw?JSON.parse(raw):{"index.html":"<!doctype html><html><head><meta charset='utf-8'><title>Exemple</title><style>body{font:16px/1.5 system-ui;margin:24px}</style></head><body><h1>Bonjour</h1><p>Modifie ce fichier puis clique Aperçu.</p></body></html>"};}catch{return {"index.html":"<!doctype html><meta charset='utf-8'><title>Exemple</title><h1>Bonjour</h1>"}}}
function saveFS(){localStorage.setItem(KEY,JSON.stringify(fs))}
function renderList(){list.innerHTML="";Object.keys(fs).sort().forEach(name=>{const li=document.createElement("li");li.dataset.name=name;li.className=name===current?"active":"";const span=document.createElement("span");span.className="name";span.textContent=name;const size=document.createElement("span");size.textContent=(new Blob([fs[name]]).size)+"o";li.appendChild(span);li.appendChild(size);li.onclick=()=>openFile(name);list.appendChild(li)})}
function openFile(name){if(!fs[name])return;commitState();current=name;code.value=fs[name];renderList();resetHistoryIfNeeded(name)}
function resetHistoryIfNeeded(name){if(!history[name]){history[name]=[fs[name]];cursor[name]=0}else{cursor[name]=history[name].length-1}}
function commitState(){if(!current)return;const arr=history[current]||[fs[current]];const idx=cursor[current]??(arr.length-1);const latest=arr[idx];if(code.value!==latest){const next=arr.slice(0,idx+1);next.push(code.value);history[current]=next;cursor[current]=next.length-1;fs[current]=code.value;saveFS()}}
function preview(){commitState();const blob=new Blob([fs[current]||""],{type:"text/html"});frame.src=URL.createObjectURL(blob)}
function ensureSelection(){if(!current){const first=Object.keys(fs)[0];openFile(first)}}

document.getElementById("new").onclick=()=>{if(lock)return;let name=prompt("Nom du fichier","nouveau.html");if(!name)return;if(fs[name]){alert("Existe déjà");return}fs[name]="";saveFS();renderList();openFile(name)};
document.getElementById("rename").onclick=()=>{if(lock)return;ensureSelection();if(!current)return;const nv=prompt("Nouveau nom",current);if(!nv||nv===current)return;if(fs[nv]){alert("Existe déjà");return}fs[nv]=fs[current];delete fs[current];history[nv]=history[current];cursor[nv]=cursor[current];delete history[current];delete cursor[current];saveFS();renderList();openFile(nv)};
document.getElementById("delete").onclick=()=>{if(lock)return;ensureSelection();if(!current)return;if(!confirm("Supprimer "+current+" ?"))return;delete fs[current];delete history[current];delete cursor[current];saveFS();current=null;renderList();ensureSelection();preview()};
document.getElementById("save").onclick=()=>{if(lock)return;commitState();setStatus("Enregistré");preview();setTimeout(()=>setStatus(""),1000)};
document.getElementById("download").onclick=async()=>{if(lock)return;const zip=new JSZip();for(const [name,content] of Object.entries(fs)){zip.file(name,content)}const blob=await zip.generateAsync({type:"blob"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="projet.zip";a.click();URL.revokeObjectURL(a.href)};
document.getElementById("import").onclick=()=>{if(lock)return;document.getElementById("zip").click()};
document.getElementById("zip").onchange=async e=>{if(lock)return;const f=e.target.files[0];if(!f)return;const zip=await JSZip.loadAsync(f);let imported=0;for(const path of Object.keys(zip.files)){const file=zip.files[path];if(file.dir)continue;const content=await file.async("string");fs[path]=content;imported++}if(imported===0){alert("ZIP vide");return}saveFS();renderList();openFile(Object.keys(fs)[0]);preview()};
document.getElementById("preview").onclick=()=>{if(lock)return;preview()};
document.getElementById("reset").onclick=()=>{if(lock)return;if(!confirm("Réinitialiser le studio ?"))return;localStorage.removeItem(KEY);location.reload()};

code.addEventListener("input",()=>{clearTimeout(typingTimer);typingTimer=setTimeout(()=>{commitState();preview()},350)});

document.getElementById("ai-propose").onclick=async()=>{if(lock)return;setLock(true);setStatus("IA en cours");try{const res=await window.ai.generate(promptInput.value||"");if(res&&res.files){fs=window.ai.loadFS();renderList();const names=Object.keys(res.files);const target=names.includes("index.html")?"index.html":names[0];if(target)openFile(target);preview()}setStatus(res.summary?res.summary:"IA terminé");setTimeout(()=>setStatus(""),1500)}catch(e){setStatus("Erreur IA")}finally{setLock(false)}};
document.getElementById("ai-analyze").onclick=async()=>{if(lock)return;setLock(true);setStatus("Analyse en cours");try{const res=await window.ai.analyze();const html=["<!doctype html><meta charset='utf-8'><title>Analyse</title><style>body{font:14px system-ui;margin:20px;line-height:1.6;color:#e5e7eb;background:#0b1324}h1{margin:0 0 8px}h2{margin:16px 0 8px}ul{padding-left:18px}</style><h1>Analyse</h1>",section("Problèmes",res.issues),section("Actions",res.actions),section("Avertissements",res.warnings)].join("");frame.srcdoc=html;setStatus("Analyse affichée");setTimeout(()=>setStatus(""),1500)}catch(e){setStatus("Erreur analyse")}finally{setLock(false)}};
function section(title,items){const arr=Array.isArray(items)?items:[];return "<h2>"+title+"</h2><ul>"+arr.map(x=>"<li>"+String(x)+"</li>").join("")+"</ul>"}

applyMobileMode();
renderList();ensureSelection();preview();
</script>
<script>
if("serviceWorker" in navigator){window.addEventListener("load",()=>{navigator.serviceWorker.register("sw.js")})}
</script>
</body></html>document.getElementById("rename").onclick=()=>{if(lock)return;ensureSelection();if(!current)return;const nv=prompt("Nouveau nom",current);if(!nv||nv===current)return;if(fs[nv]){alert("Existe déjà");return}fs[nv]=fs[current];delete fs[current];history[nv]=history[current];cursor[nv]=cursor[current];delete history[current];delete cursor[current];saveFS();renderList();openFile(nv)};
document.getElementById("delete").onclick=()=>{if(lock)return;ensureSelection();if(!current)return;if(!confirm("Supprimer "+current+" ?"))return;delete fs[current];delete history[current];delete cursor[current];saveFS();current=null;renderList();ensureSelection();preview()};
document.getElementById("save").onclick=()=>{if(lock)return;commitState();setStatus("Enregistré");preview();setTimeout(()=>setStatus(""),1000)};
document.getElementById("download").onclick=async()=>{if(lock)return;const zip=new JSZip();for(const [name,content] of Object.entries(fs)){zip.file(name,content)}const blob=await zip.generateAsync({type:"blob"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="projet.zip";a.click();URL.revokeObjectURL(a.href)};
document.getElementById("import").onclick=()=>{if(lock)return;document.getElementById("zip").click()};
document.getElementById("zip").onchange=async e=>{if(lock)return;const f=e.target.files[0];if(!f)return;const zip=await JSZip.loadAsync(f);let imported=0;for(const path of Object.keys(zip.files)){const file=zip.files[path];if(file.dir)continue;const content=await file.async("string");fs[path]=content;imported++}if(imported===0){alert("ZIP vide");return}saveFS();renderList();openFile(Object.keys(fs)[0]);preview()};
document.getElementById("preview").onclick=()=>{if(lock)return;preview()};
document.getElementById("reset").onclick=()=>{if(lock)return;if(!confirm("Réinitialiser le studio ?"))return;localStorage.removeItem(KEY);location.reload()};

code.addEventListener("input",()=>{clearTimeout(typingTimer);typingTimer=setTimeout(()=>{commitState();preview()},350)});

document.getElementById("ai-propose").onclick=async()=>{if(lock)return;setLock(true);setStatus("IA en cours");try{const res=await window.ai.generate(promptInput.value||"");if(res&&res.files){fs=window.ai.loadFS();renderList();const names=Object.keys(res.files);const target=names.includes("index.html")?"index.html":names[0];if(target)openFile(target);preview()}setStatus(res.summary?res.summary:"IA terminé");setTimeout(()=>setStatus(""),1500)}catch(e){setStatus("Erreur IA")}finally{setLock(false)}};
document.getElementById("ai-analyze").onclick=async()=>{if(lock)return;setLock(true);setStatus("Analyse en cours");try{const res=await window.ai.analyze();const html=["<!doctype html><meta charset='utf-8'><title>Analyse</title><style>body{font:14px system-ui;margin:20px;line-height:1.6;color:#e5e7eb;background:#0b1324}h1{margin:0 0 8px}h2{margin:16px 0 8px}ul{padding-left:18px}</style><h1>Analyse</h1>",section("Problèmes",res.issues),section("Actions",res.actions),section("Avertissements",res.warnings)].join("");frame.srcdoc=html;setStatus("Analyse affichée");setTimeout(()=>setStatus(""),1500)}catch(e){setStatus("Erreur analyse")}finally{setLock(false)}};
function section(title,items){const arr=Array.isArray(items)?items:[];return "<h2>"+title+"</h2><ul>"+arr.map(x=>"<li>"+String(x)+"</li>").join("")+"</ul>"}

renderList();ensureSelection();preview();
</script>
</body></html>
